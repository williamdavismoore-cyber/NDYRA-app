<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Login â€” HIIT56</title>
  <link rel="icon" href="/assets/branding/Hiit56_Favicon_32x32.webp">
  <link rel="apple-touch-icon" href="/assets/branding/Hiit56_Favicon_180x180.webp">
  <meta name="theme-color" content="#000000">
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="stylesheet" href="/assets/css/styles.css">
</head>
<body data-page="login">

<div class="container">
  <div class="section-title">
    <h2>Login</h2>
    <div class="small">Real Supabase authentication</div>
  </div>

  <div class="card" style="min-height:auto;">
    <div class="meta">
      <input class="input" id="auth-email" placeholder="Email" />
      <input class="input" id="auth-password" type="password" placeholder="Password" style="margin-top:10px;" />
      <div class="btn-row" style="margin-top:15px;">
        <button class="btn primary" id="auth-login">Login</button>
        <button class="btn" id="auth-signup">Sign Up</button>
      </div>
      <div class="small" id="auth-status" style="margin-top:10px;"></div>
    </div>
  </div>
</div>

<script src="/assets/vendor/supabase/supabase.js"></script>

<script type="module">
  import { getSupabase } from "/assets/js/supabaseClient.js";
  import { ensureProfile } from "/assets/js/ensureProfile.js";

  const supabase = await getSupabase();
  const statusEl = document.getElementById("auth-status");

  async function handleAuth(type) {
    statusEl.textContent = "Processing...";

    const email = document.getElementById("auth-email").value.trim();
    const password = document.getElementById("auth-password").value.trim();

    if (!email || !password) {
      statusEl.textContent = "Email and password required.";
      return;
    }

    let result;
    if (type === "login") {
      result = await supabase.auth.signInWithPassword({ email, password });
    } else {
      result = await supabase.auth.signUp({ email, password });
    }

    if (result.error) {
      statusEl.textContent = result.error.message;
      return;
    }

    if (result.data?.user) {
      await ensureProfile(result.data.user);
      statusEl.textContent = "Success. Redirecting...";
      const next = new URLSearchParams(location.search).get("next") || "/";
      location.href = next;
    } else {
      statusEl.textContent = "Check your email to confirm your account.";
    }
  }

  document.getElementById("auth-login").onclick = () => handleAuth("login");
  document.getElementById("auth-signup").onclick = () => handleAuth("signup");
</script>

</body>
</html>
